<!DOCTYPE html>
<html>
<head>
    <title>Test Service Popup</title>
    <style>
        .service-popup-backdrop{position:fixed;inset:0;background:rgba(0,0,0,.3);backdrop-filter:blur(2px);display:none;z-index:25}
        .service-popup{position:fixed;top:50%;left:50%;transform:translate(-50%,-50%);width:min(600px,90vw);max-height:70vh;background:#fff;border-radius:16px;box-shadow:0 20px 40px rgba(0,0,0,.2);display:none;z-index:26;overflow:hidden}
        .service-popup-header{display:flex;justify-content:space-between;align-items:center;padding:16px 20px;background:#2F7D32;color:#fff}
        .service-popup-header h3{margin:0;font-size:18px}
        .service-popup-close{cursor:pointer;font-size:20px;opacity:.9}
        .service-popup-close:hover{opacity:1}
        .service-popup-body{padding:16px 20px;max-height:50vh;overflow-y:auto}
        .reference-item{margin-bottom:12px;padding:12px;background:#f8f9fa;border-radius:8px;border-left:4px solid #2F7D32}
        .reference-file{font-weight:700;color:#2F7D32;margin-bottom:4px;font-size:14px}
        .reference-line{font-size:12px;color:#666;margin-bottom:6px}
        .reference-code{font-family:monospace;background:#fff;padding:8px;border-radius:4px;border:1px solid #e9ecef;font-size:13px;white-space:pre-wrap;overflow-x:auto}
        .reference-match{background:#fff3cd;padding:2px 4px;border-radius:3px}
        .clickable-service{cursor:pointer;color:#2F7D32;text-decoration:underline;padding:10px;margin:5px;border:1px solid #ddd;border-radius:5px}
    </style>
</head>
<body>
    <h1>Test Service References Popup</h1>
    
    <div class="clickable-service" onclick="showServiceReferences('React')">
        üìç React: 6 ref(s) (Click me!)
    </div>
    
    <div class="clickable-service" onclick="showServiceReferences('AWS S3')">
        üìç AWS S3: 50 ref(s) (Click me!)
    </div>

    <!-- Service References Popup -->
    <div id="servicePopupBackdrop" class="service-popup-backdrop"></div>
    <div id="servicePopup" class="service-popup">
        <div class="service-popup-header">
            <h3 id="servicePopupTitle">Service References</h3>
            <span id="servicePopupClose" class="service-popup-close">‚úñ</span>
        </div>
        <div class="service-popup-body" id="servicePopupBody">
            <!-- References will be populated here -->
        </div>
    </div>

    <script>
        // Mock data for testing
        window.servicesReferencesData = {
            'React': {
                count: 6,
                references: [
                    {
                        file: 'src/App.js',
                        line: 1,
                        code: 'import React from "react";',
                        match: 'React'
                    },
                    {
                        file: 'src/components/Header.js',
                        line: 3,
                        code: 'const Header = () => <div>React Component</div>',
                        match: 'React'
                    },
                    {
                        file: 'package.json',
                        line: 15,
                        code: '"react": "^18.2.0",',
                        match: 'react'
                    }
                ]
            },
            'AWS S3': {
                count: 50,
                references: [
                    {
                        file: 'src/services/storage.js',
                        line: 5,
                        code: 'const s3 = new AWS.S3();',
                        match: 's3'
                    },
                    {
                        file: 'src/utils/upload.js',
                        line: 12,
                        code: 'await s3.upload(params).promise();',
                        match: 's3'
                    }
                ]
            }
        };

        const servicePopupBackdrop = document.getElementById('servicePopupBackdrop');
        const servicePopup = document.getElementById('servicePopup');
        const servicePopupClose = document.getElementById('servicePopupClose');
        const servicePopupTitle = document.getElementById('servicePopupTitle');
        const servicePopupBody = document.getElementById('servicePopupBody');

        function showServiceReferences(serviceName) {
            const serviceData = window.servicesReferencesData?.[serviceName];
            if (!serviceData || !serviceData.references?.length) {
                alert('No code references found for this service.');
                return;
            }

            servicePopupTitle.textContent = `${serviceName} - Code References`;
            
            const referencesHtml = serviceData.references.map(ref => {
                const highlightedCode = ref.code.replace(
                    new RegExp(escapeRegex(ref.match), 'gi'),
                    `<span class="reference-match">${ref.match}</span>`
                );
                
                return `
                    <div class="reference-item">
                        <div class="reference-file">${ref.file}</div>
                        <div class="reference-line">Line ${ref.line}</div>
                        <div class="reference-code">${highlightedCode}</div>
                    </div>
                `;
            }).join('');
            
            servicePopupBody.innerHTML = referencesHtml;
            servicePopupBackdrop.style.display = 'block';
            servicePopup.style.display = 'block';
            document.body.style.overflow = 'hidden';
        }

        function closeServicePopup() {
            servicePopupBackdrop.style.display = 'none';
            servicePopup.style.display = 'none';
            document.body.style.overflow = '';
        }

        function escapeRegex(string) {
            return string.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
        }

        servicePopupBackdrop.addEventListener('click', closeServicePopup);
        servicePopupClose.addEventListener('click', closeServicePopup);
        window.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                closeServicePopup();
            }
        });
    </script>
</body>
</html>