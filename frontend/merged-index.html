<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ðŸ§± Intellens Project Analyzer</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{
      --lego-block-img: url("file:///C:/Users/parth/Intellens/frontend/blocks.png.png");
      --lego-block-img-fallback: url("blocks.png.png");
    }

    *{ box-sizing:border-box; margin:0; padding:0; font-family:"Poppins",sans-serif; }
    body{
      background: radial-gradient(circle at 25% 25%, #f0f3f9, #dfe6ee);
      height:100vh; overflow:hidden; display:flex; align-items:center; justify-content:center;
    }

    #start-screen{
      width:100%; height:100%;
      display:flex; flex-direction:column; align-items:center; justify-content:center;
      transition:opacity .6s ease;
    }
    .upload-box{
      border:3px dashed #ccc; border-radius:20px; padding:60px; text-align:center;
      background:#fff; width:420px; box-shadow:0 10px 30px rgba(0,0,0,.05);
      transition:all .3s; cursor:pointer;
    }
    .upload-box:hover{ border-color:#4ECDC4; transform:scale(1.03); }
    .lego-loader{ display:none; gap:8px; justify-content:center; margin-top:20px; }
    .lego-loader .lego-block{ width:25px; height:25px; border-radius:6px; background:#4ECDC4; animation:bounce 1.6s infinite ease-in-out; }
    .lego-loader .lego-block:nth-child(2){ background:#FF6B35; animation-delay:.2s; }
    .lego-loader .lego-block:nth-child(3){ background:#FFD166; animation-delay:.4s; }
    @keyframes bounce{ 0%,100%{transform:translateY(0)} 50%{transform:translateY(-10px)} }

    #dashboard{ display:none; width:100%; height:100%; background:linear-gradient(180deg,#ffffff,#f5f7fa); position:relative; }
    .sidebar{
      position:absolute; inset:0 auto 0 0; width:260px; background:linear-gradient(180deg,#232f3e,#39465a);
      color:#fff; display:flex; flex-direction:column; align-items:center; padding:28px 16px; gap:18px;
      box-shadow:4px 0 8px rgba(0,0,0,.10);
    }
    .sidebar .brand{ font-size:1.25rem; font-weight:700; letter-spacing:.5px; margin-bottom:6px; }

    .menu-block{
      width:100%; max-width:210px; height:110px; border:none;
      background: var(--lego-block-img) center/cover no-repeat, var(--lego-block-img-fallback) center/cover no-repeat, #2a3a4f;
      border-radius:16px; cursor:pointer; position:relative; transition:transform .12s ease, filter .12s ease;
      box-shadow: 0 10px 18px rgba(0,0,0,.25), inset 0 -6px 10px rgba(0,0,0,.25), inset 0 6px 10px rgba(255,255,255,.12);
      display:flex; align-items:center; justify-content:center; padding:0 14px;
    }
    .menu-block:hover{ transform: translateY(-2px); filter: saturate(1.05) brightness(1.02); }
    .menu-block:active{ transform: translateY(1px); filter: brightness(.95); }

    .menu-block .label{
      font-weight:800; font-size:1.05rem; letter-spacing:.5px; text-transform:uppercase;
      color:#1b2a1a; text-align:center;
      text-shadow: 0.5px 0.5px 0 rgba(0,0,0,.65), -0.5px -0.5px 0 rgba(255,255,255,.35), 0 2px 2px rgba(0,0,0,.35);
      mix-blend-mode:multiply; user-select:none; pointer-events:none;
    }

    .dashboard-block{
      position:absolute; left:260px; right:0; top:0; bottom:0; margin:40px;
      display:flex; align-items:center; justify-content:center;
      background: repeating-linear-gradient(45deg,#f8fafc 0,#f8fafc 20px,#f1f5f9 20px,#f1f5f9 40px);
      border-radius:20px; box-shadow: inset 0 0 20px rgba(0,0,0,.05);
      font-size:1.2rem; color:#333; padding:20px;
    }

    .fullscreen-section{
      position:fixed; inset:24px 24px 24px 284px;
      background:#fff; border-radius:20px; box-shadow:0 0 40px rgba(0,0,0,.30);
      transform:scale(.94); opacity:0; pointer-events:none; transition:all .35s ease;
      padding:28px; overflow:auto; z-index:100;
    }
    .fullscreen-section.active{ transform:scale(1); opacity:1; pointer-events:auto; }
    .close-btn{
      position:absolute; top:16px; right:22px; font-size:28px; color:#ff6b35; cursor:pointer; transition:transform .15s;
    }
    .close-btn:hover{ transform:scale(1.15); }

    .section-title{ margin-bottom:14px; }
    #languages,#services,#file-details{ margin:12px 0; }
    
    /* Original styles for content */
    .item { background: #f8f9fa; padding: 10px; border-radius: 3px; margin: 5px 0; cursor: pointer; }
    .item:hover { background: #e9ecef; }
    .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; }
    .file-item { background: #f8f9fa; border: 1px solid #e9ecef; border-radius: 6px; padding: 12px; margin: 8px 0; }
    .file-name { font-weight: bold; color: #495057; margin-bottom: 8px; font-family: monospace; font-size: 13px; }
    .file-tags { display: flex; flex-wrap: wrap; gap: 6px; }
    .tag { padding: 3px 8px; border-radius: 12px; font-size: 11px; font-weight: 500; }
    .tag.language { background: #e3f2fd; color: #1976d2; border: 1px solid #bbdefb; }
    .tag.service { background: #f3e5f5; color: #7b1fa2; border: 1px solid #e1bee7; }
    
    /* Architecture styles */
    .system-architecture { text-align: center; }
    .arch-layer { margin: 30px 0; }
    .arch-row { display: flex; justify-content: center; gap: 30px; flex-wrap: wrap; margin: 20px 0; }
    .arch-component { padding: 20px; border: 2px solid #ddd; border-radius: 12px; background: white; text-align: center; min-width: 140px; box-shadow: 0 4px 8px rgba(0,0,0,0.1); }
    .arch-component.user { border-color: #28a745; background: #f8fff9; }
    .arch-component.application { border-color: #007bff; background: #f0f8ff; }
    .arch-component.database { border-color: #ffc107; background: #fffdf0; }
    .comp-title { font-weight: bold; margin: 10px 0; color: #333; }
    .comp-desc { font-size: 12px; color: #666; line-height: 1.3; }
    .flow-connection { text-align: center; margin: 20px 0; }
    .flow-arrow-down { font-size: 30px; color: #007bff; margin: 10px 0; font-weight: bold; }
    .flow-label { font-size: 14px; color: #666; font-style: italic; margin: 5px 0; background: #f8f9fa; padding: 8px 20px; border-radius: 20px; display: inline-block; border: 1px solid #e9ecef; }
    
    button { background: #007bff; color: white; border: none; padding: 10px 20px; border-radius: 5px; cursor: pointer; margin: 5px; }
    button:hover { background: #0056b3; }
  </style>
</head>
<body>

  <div id="start-screen">
    <h1 style="margin-bottom:24px; color:#232f3e;">ðŸ§± Intellens Project Analyzer</h1>
    <div class="upload-box" onclick="document.getElementById('fileInput').click()">
      <input type="file" id="fileInput" accept=".zip" style="display:none" onchange="uploadFile()">
      <p>ðŸ“¦ Click to upload your <strong>.zip</strong> project</p>
      <div class="lego-loader" id="legoLoader">
        <div class="lego-block"></div><div class="lego-block"></div><div class="lego-block"></div>
      </div>
    </div>
  </div>

  <div id="dashboard">
    <aside class="sidebar">
      <div class="brand">Dashboard</div>

      <button class="menu-block" onclick="openSection('project-summary')">
        <span class="label">Summary</span>
      </button>

      <button class="menu-block" onclick="openSection('system-arch')">
        <span class="label">Architecture</span>
      </button>

      <button class="menu-block" onclick="openSection('terraform')">
        <span class="label">Terraform</span>
      </button>

      <button class="menu-block" onclick="openSection('components')">
        <span class="label">Components</span>
      </button>

      <button class="menu-block" onclick="openSection('frontend')">
        <span class="label">Frontend</span>
      </button>

      <button class="menu-block" onclick="openSection('readme')">
        <span class="label">README</span>
      </button>
    </aside>

    <div class="dashboard-block">Select a section from the sidebar to view its analysis ðŸ§©</div>
  </div>

  <section id="project-summary" class="fullscreen-section">
    <div class="close-btn" onclick="closeSection()">âœ–</div>
    <h2 class="section-title">Project Summary</h2>
    <div class="grid">
      <div>
        <h3>Languages</h3>
        <div id="languages"></div>
      </div>
      <div>
        <h3>Services & Technologies</h3>
        <div id="services"></div>
      </div>
    </div>
    <div style="margin-top: 20px;">
      <h3>File Details</h3>
      <div id="file-details"></div>
    </div>
  </section>

  <section id="system-arch" class="fullscreen-section">
    <div class="close-btn" onclick="closeSection()">âœ–</div>
    <h2 class="section-title">System Architecture</h2>
    <div id="workflow-diagram"></div>
  </section>

  <section id="terraform" class="fullscreen-section">
    <div class="close-btn" onclick="closeSection()">âœ–</div>
    <h2 class="section-title">Terraform Infrastructure</h2>
    <div id="terraform-diagram"></div>
  </section>

  <section id="components" class="fullscreen-section">
    <div class="close-btn" onclick="closeSection()">âœ–</div>
    <h2 class="section-title">Component Diagram</h2>
    <div id="diagram">
      <div id="nodes"></div>
      <div id="connections"></div>
    </div>
  </section>

  <section id="frontend" class="fullscreen-section">
    <div class="close-btn" onclick="closeSection()">âœ–</div>
    <h2 class="section-title">Frontend Preview</h2>
    <div id="frontend-preview"></div>
  </section>

  <section id="readme" class="fullscreen-section">
    <div class="close-btn" onclick="closeSection()">âœ–</div>
    <h2 class="section-title">Generated README</h2>
    <button onclick="copyReadme()">Copy to Clipboard</button>
    <button onclick="downloadReadme()">Download README.md</button>
    <pre id="readme-content" style="background: #f8f9fa; padding: 15px; border-radius: 5px; white-space: pre-wrap; font-family: monospace; font-size: 13px; margin-top: 15px;"></pre>
  </section>

  <script src="aws-tech-diagram.js"></script>
  <script src="enhanced-aws-tech-diagram.js"></script>
  <script src="aws-infrastructure-designer.js"></script>
  <script>
    let analysisData = {};

    async function uploadFile(){
      const file = document.getElementById('fileInput').files[0];
      if(!file) return;
      document.getElementById('legoLoader').style.display = 'flex';

      const formData = new FormData();
      formData.append('file', file);

      try{
        const res = await fetch('http://localhost:8000/upload', { method:'POST', body:formData });
        const data = await res.json();
        analysisData = data;
        displayResults(data);

        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('dashboard').style.display = 'block';
      }catch(err){
        alert('Upload failed: ' + err.message);
      }finally{
        document.getElementById('legoLoader').style.display = 'none';
      }
    }

    function displayResults(data) {
      // Languages
      document.getElementById('languages').innerHTML = Object.entries(data.languages)
        .map(([lang, count]) => `<div class="item" onclick="filterFiles('${lang}', 'language')">${lang}: ${count} files</div>`)
        .join('');
      
      // Services
      let allServices = {...data.services};
      if (data.aws_infrastructure_diagram && data.aws_infrastructure_diagram.summary) {
        const awsServices = data.aws_infrastructure_diagram.summary.service_types || [];
        awsServices.forEach(service => {
          if (!allServices[service]) {
            allServices[service + ' (Recommended)'] = 1;
          }
        });
      }
      
      if (Object.keys(allServices).length > 0) {
        document.getElementById('services').innerHTML = Object.entries(allServices)
          .map(([service, count]) => `<div class="item" onclick="filterFiles('${service}', 'service')">${service}: ${count} refs</div>`)
          .join('');
      } else {
        document.getElementById('services').innerHTML = '<div class="item">No services detected</div>';
      }
      
      // File details
      if (data.file_details && data.file_details.length > 0) {
        document.getElementById('file-details').innerHTML = data.file_details
          .map(file => {
            const languageTags = file.languages.map(lang => `<span class="tag language">${lang}</span>`).join('');
            const serviceTags = file.services.map(service => `<span class="tag service">${service}</span>`).join('');
            return `
              <div class="file-item">
                <div class="file-name">${file.file}</div>
                <div class="file-tags">${languageTags}${serviceTags}</div>
              </div>
            `;
          }).join('');
      }
      
      // Architecture
      if (data.workflow_diagram) {
        const arch = data.workflow_diagram.architecture;
        const users = arch.components.filter(c => c.type === 'user');
        const apps = arch.components.filter(c => c.type === 'application');
        const databases = arch.components.filter(c => c.type === 'database');
        
        const renderComponent = (comp) => `
          <div class="arch-component ${comp.type}">
            <img src="${comp.logo}" alt="${comp.title}" style="width: 40px; height: 40px;">
            <div class="comp-title">${comp.title}</div>
            <div class="comp-desc">${comp.description}</div>
          </div>
        `;
        
        document.getElementById('workflow-diagram').innerHTML = `
          <div class="system-architecture">
            <div class="arch-layer">
              <h4>Actors</h4>
              <div class="arch-row">${users.map(renderComponent).join('')}</div>
            </div>
            <div class="flow-connection">
              <div class="flow-arrow-down">â†“</div>
              <div class="flow-label">Sends requests</div>
            </div>
            <div class="arch-layer">
              <h4>Application Layer</h4>
              <div class="arch-row">${apps.map(renderComponent).join('')}</div>
            </div>
            ${databases.length > 0 ? `
              <div class="flow-connection">
                <div class="flow-arrow-down">â†“</div>
                <div class="flow-label">Stores data</div>
              </div>
              <div class="arch-layer">
                <h4>Data Storage</h4>
                <div class="arch-row">${databases.map(renderComponent).join('')}</div>
              </div>
            ` : ''}
          </div>
        `;
      }
      
      // Components
      if (data.comprehensive_diagram) {
        document.getElementById('nodes').innerHTML = '<h4>Components:</h4>' + 
          data.comprehensive_diagram.nodes.map(node => 
            `<div class="item">${node.label} (${node.category})</div>`
          ).join('');
        
        document.getElementById('connections').innerHTML = '<h4>Connections:</h4>' + 
          data.comprehensive_diagram.edges.map(edge => 
            `<div class="item">${edge.source} â†’ ${edge.target}</div>`
          ).join('');
      }
      
      // Frontend preview
      const frontendPreviewDiv = document.getElementById('frontend-preview');
      if (data.frontend_preview) {
        frontendPreviewDiv.innerHTML = data.frontend_preview;
      } else {
        frontendPreviewDiv.innerHTML = '<div style="text-align: center; padding: 40px; color: #666;"><h3>No Frontend Detected</h3><p>This project appears to be a backend/CLI application.</p></div>';
      }
      
      // README
      document.getElementById('readme-content').textContent = data.readme_content || 'No README content generated';
      window.currentReadmeFilename = data.readme_filename;
      window.allFileDetails = data.file_details || [];
    }

    function openSection(id){
      closeSection();
      const section = document.getElementById(id);
      section.classList.add('active');

      if(id === 'terraform' && analysisData.aws_infrastructure_diagram){
        const target = document.getElementById('terraform-diagram');
        target.innerHTML = '';
        try {
          renderAWSInfrastructureDiagram(target, analysisData.aws_infrastructure_diagram);
        } catch (error) {
          const summary = analysisData.aws_infrastructure_diagram.summary;
          if (summary && summary.service_types) {
            target.innerHTML = `
              <div style="padding: 20px;">
                <h3>AWS Infrastructure Recommendations</h3>
                <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 15px; margin: 20px 0;">
                  ${summary.service_types.map(service => `
                    <div style="border: 1px solid #ddd; border-radius: 8px; padding: 15px; background: white;">
                      <div style="font-weight: bold; color: #007bff;">${service}</div>
                    </div>
                  `).join('')}
                </div>
              </div>
            `;
          }
        }
      }
    }

    function closeSection(){
      document.querySelectorAll('.fullscreen-section').forEach(s => s.classList.remove('active'));
    }

    function filterFiles(term, type) {
      const filteredFiles = window.allFileDetails.filter(file => {
        return type === 'language' ? file.languages.includes(term) : file.services.includes(term);
      });
      
      if (filteredFiles.length > 0) {
        document.getElementById('file-details').innerHTML = `
          <div style="margin-bottom: 10px; font-weight: bold; color: #007bff;">
            Files using ${term}: <span onclick="showAllFiles()" style="cursor: pointer; text-decoration: underline; font-weight: normal;">(show all)</span>
          </div>
        ` + filteredFiles.map(file => {
          const languageTags = file.languages.map(lang => `<span class="tag language">${lang}</span>`).join('');
          const serviceTags = file.services.map(service => `<span class="tag service">${service}</span>`).join('');
          return `
            <div class="file-item">
              <div class="file-name">${file.file}</div>
              <div class="file-tags">${languageTags}${serviceTags}</div>
            </div>
          `;
        }).join('');
      }
    }
    
    function showAllFiles() {
      if (window.allFileDetails.length > 0) {
        document.getElementById('file-details').innerHTML = window.allFileDetails.map(file => {
          const languageTags = file.languages.map(lang => `<span class="tag language">${lang}</span>`).join('');
          const serviceTags = file.services.map(service => `<span class="tag service">${service}</span>`).join('');
          return `
            <div class="file-item">
              <div class="file-name">${file.file}</div>
              <div class="file-tags">${languageTags}${serviceTags}</div>
            </div>
          `;
        }).join('');
      }
    }
    
    function copyReadme() {
      const readmeContent = document.getElementById('readme-content').textContent;
      navigator.clipboard.writeText(readmeContent).then(() => {
        alert('README copied to clipboard!');
      });
    }
    
    function downloadReadme() {
      if (window.currentReadmeFilename) {
        const link = document.createElement('a');
        link.href = `http://localhost:8000/download-readme/${window.currentReadmeFilename}`;
        link.download = 'README.md';
        link.click();
      }
    }
  </script>
</body>
</html>